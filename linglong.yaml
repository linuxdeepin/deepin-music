# SPDX-FileCopyrightText: 2023 - 2026 UnionTech Software Technology Co., Ltd.
#
# SPDX-License-Identifier: GPL-3.0-or-later

version: "1"

package:
  id: org.deepin.music
  name: "deepin-music"
  version: 7.0.54.1
  kind: app
  description: |
    music for deepin os.

base: org.deepin.base/25.2.2
# 解决 "Failed to initialize graphics backend for OpenGL."
runtime: org.deepin.runtime.webengine/25.2.2

command:
  - deepin-music

build: |
  # 下载和安装依赖
  apt -y install --download-only libavutil-dev libavcodec-dev libavformat-dev libdtk6core-bin libdtk6gui-dev libdtk6widget-dev libdbusextended-qt5-dev libgsettings-qt-dev libicu-dev libmpris-qt6-dev libtag1-dev qt6-svg-dev libqt6sql6-sqlite libxtst-dev libvlc-dev libvlccore-dev vlc-plugin-base qt6-multimedia-dev qt6-tools-dev qt6-tools-dev-tools qml6-module-qtquick-dialogs qt6-declarative-dev libdtk6declarative-dev qt6-5compat-dev libsdl2-dev libsdl1.2debian
  bash ./install_dep /var/cache/apt/archives "$PREFIX"

  # 修改路径
  sed -i "s|/usr|$PREFIX|g" src/libdmusic/CMakeLists.txt

  # 构建
  VERSION=$(head -1 debian/changelog | awk -F'[()]' '{print $2}')
  cmake -B build \
      -DCMAKE_BUILD_TYPE=Release \
      -DCMAKE_INSTALL_PREFIX=${PREFIX} \
      -DCMAKE_INSTALL_LIBDIR=${PREFIX}/lib/${TRIPLET} \
      -DAPP_VERSION=${VERSION} \
      -DVERSION=${VERSION}
  cmake --build build -j`nproc`
  cmake --build build --target install > install.log 2>&1
  # update for libdmusic.so
  ldconfig -C "$LINGLONG_LD_SO_CACHE"

  # 项目生成应用名和动态隐式加载的依赖库，ldd无法找到的其他库
  LDD_FILES=(
    deepin-music
    libvlccore.so
    libvlc.so
    libavcodec.so
    libavformat.so
    libSDL2-2.0.so
  )

  # 生成.install 文件
  bash ./deploy_dep "${LDD_FILES[@]}"
  ID_VALUE=$(awk -F ': ' '/^  id: / {print $2}' linglong.yaml)
  find ${PREFIX}/lib/${TRIPLET}/vlc >> "${ID_VALUE}.install"

  # 将 vlc 子目录下的 libvlc_pulse.so 复制到标准库路径，确保动态链接器能找到
  if [ -f "${PREFIX}/lib/${TRIPLET}/vlc/libvlc_pulse.so.0" ]; then
    cp -a "${PREFIX}/lib/${TRIPLET}/vlc/libvlc_pulse.so"* "${PREFIX}/lib/${TRIPLET}/"
    ls "${PREFIX}/lib/${TRIPLET}/libvlc_pulse.so"* >> "${ID_VALUE}.install"
  fi

# allow apt download in build and do apt update
buildext:
  apt:
    build_depends:
      - libc6
